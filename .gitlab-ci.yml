# GitLab CI - Basic VITALS Check
stages:
  - test
  - performance
  - report

variables:
  PROMETHEUS_URL: "https://prometheus.example.com"

vitals-regression-check:
  stage: performance
  image: node:20
  
  before_script:
    - npm install -g @vitals/cli
  
  cache:
    key: vitals-cache-${CI_PROJECT_ID}
    paths:
      - .vitals-cache/
  
  script:
    - |
      vitals batch regression \
        --config vitals.yaml \
        --prometheus-url $PROMETHEUS_URL \
        --baseline-label "prod-${CI_MERGE_REQUEST_TARGET_BRANCH_SHA}" \
        --candidate-label "prod-${CI_MERGE_REQUEST_SOURCE_BRANCH_SHA}" \
        --post-mr-comment \
        --dashboard-url "https://grafana.example.com/d/vitals" \
        --cache-enabled \
        --cache-ttl 300
  
  artifacts:
    paths:
      - vitals-results/
    reports:
      junit: vitals-results/junit-report.xml
    when: always
    expire_in: 30 days
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

vitals-report:
  stage: report
  image: alpine:latest
  
  dependencies:
    - vitals-regression-check
  
  script:
    - |
      if [ -f vitals-results/summary.txt ]; then
        cat vitals-results/summary.txt
      fi
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
