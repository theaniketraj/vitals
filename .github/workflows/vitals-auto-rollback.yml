name: VITALS with Auto-Rollback

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: write
  deployments: write

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy to Staging
        run: |
          echo "Deploying to staging..."
          # Your deployment script here
          ./deploy.sh staging
      
      - name: Wait for Metrics
        run: sleep 60  # Wait for metrics to stabilize
  
  vitals-check:
    needs: deploy-staging
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: VITALS Regression Check
        id: vitals
        uses: vitals-dev/vitals-action@v1
        with:
          prometheus-url: ${{ secrets.PROMETHEUS_URL }}
          baseline-label: 'prod-baseline'
          candidate-label: 'staging-${{ github.sha }}'
          config-file: 'vitals.yaml'
          fail-on-regression: false  # Don't fail, we'll handle it
      
      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitals-results
          path: vitals-results/
      
      - name: Set Rollback Flag
        id: rollback
        run: |
          if [[ "${{ steps.vitals.outputs.verdict }}" == "FAIL" ]]; then
            echo "needed=true" >> $GITHUB_OUTPUT
          else
            echo "needed=false" >> $GITHUB_OUTPUT
          fi
  
  rollback:
    needs: vitals-check
    if: needs.vitals-check.outputs.rollback == 'true'
    runs-on: ubuntu-latest
    environment:
      name: staging
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Rollback Deployment
        run: |
          echo "Performance regression detected, rolling back..."
          ./rollback.sh staging
      
      - name: Create Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Performance regression detected in ${context.sha}`,
              body: `Automatic rollback triggered due to performance regression.\n\nSee workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['performance', 'regression', 'auto-rollback']
            });
  
  deploy-production:
    needs: vitals-check
    if: needs.vitals-check.outputs.rollback == 'false'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://example.com
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Deploy to Production
        run: |
          echo "No regressions detected, deploying to production..."
          ./deploy.sh production
